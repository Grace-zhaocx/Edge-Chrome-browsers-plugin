<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>飞书API测试页面</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #6b7280; }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            min-height: 100px;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 飞书多维表格API测试</h1>
        
        <div class="test-section">
            <h3>1. 配置测试</h3>
            <p class="info">首先设置飞书API配置信息</p>
            <button onclick="setupConfig()">设置配置</button>
            <button onclick="verifyConfig()">验证配置</button>
        </div>

        <div class="test-section">
            <h3>2. API连接测试</h3>
            <p class="info">测试与飞书API的连接</p>
            <button onclick="testConnection()">测试连接</button>
            <button onclick="getTableInfo()">获取表格信息</button>
            <button onclick="getFields()">获取字段信息</button>
        </div>

        <div class="test-section">
            <h3>3. 数据操作测试</h3>
            <p class="info">测试数据的创建、读取和更新</p>
            <button onclick="createTestRecord()">创建测试记录</button>
            <button onclick="searchRecords()">搜索记录</button>
            <button onclick="getAllRecords()">获取所有记录</button>
        </div>

        <div class="test-section">
            <h3>4. 模拟插件操作</h3>
            <p class="info">模拟浏览器插件的实际操作</p>
            <button onclick="simulateBookmark()">模拟网页收藏</button>
            <button onclick="testDuplicateCheck()">测试重复检查</button>
        </div>

        <div id="results">
            <p>测试结果将显示在这里...</p>
        </div>
    </div>

    <script>
        const API_CONFIG = {
            tenantAccessToken: 't-g1049ffnJ7Z6E65FESDLBPIHQ6MAEQUOFFI6G5C4',
            baseId: 'H5xQwaTxDiDE6SkUulZcRgOoneh',
            tableId: 'tblQWm4ttkQD7QH0'
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').innerHTML = '';
        }

        async function setupConfig() {
            clearLog();
            log('设置飞书API配置...');
            
            try {
                // 模拟设置Chrome扩展配置
                localStorage.setItem('feishu_config', JSON.stringify(API_CONFIG));
                log('✅ 配置设置成功', 'success');
                log(`BaseID: ${API_CONFIG.baseId}`);
                log(`TableID: ${API_CONFIG.tableId}`);
            } catch (error) {
                log(`❌ 配置设置失败: ${error.message}`, 'error');
            }
        }

        async function verifyConfig() {
            log('验证配置...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                const required = ['tenantAccessToken', 'baseId', 'tableId'];
                const missing = required.filter(key => !config[key]);
                
                if (missing.length > 0) {
                    log(`❌ 缺少必需配置: ${missing.join(', ')}`, 'error');
                } else {
                    log('✅ 配置验证通过', 'success');
                }
            } catch (error) {
                log(`❌ 验证失败: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            log('测试API连接...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ API连接成功', 'success');
                    log(`表格名称: ${data.data?.table?.name || '未知'}`);
                } else {
                    log(`❌ API连接失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 连接测试失败: ${error.message}`, 'error');
            }
        }

        async function getTableInfo() {
            log('获取表格信息...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ 表格信息获取成功', 'success');
                    log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`);
                } else {
                    log(`❌ 获取失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 获取表格信息失败: ${error.message}`, 'error');
            }
        }

        async function getFields() {
            log('获取字段信息...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/fields`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ 字段信息获取成功', 'success');
                    log(`共找到 ${data.data?.items?.length || 0} 个字段:`);
                    
                    data.data?.items?.forEach((field, index) => {
                        log(`${index + 1}. ${field.field_name} (${field.type})`);
                    });
                } else {
                    log(`❌ 获取失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 获取字段信息失败: ${error.message}`, 'error');
            }
        }

        async function createTestRecord() {
            log('创建测试记录...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const testRecord = {
                    fields: {
                        '标题': '测试网页标题 - ' + new Date().toLocaleString(),
                        '链接': 'https://example.com/test-' + Date.now(),
                        '描述': '这是一个API测试记录',
                        '标签': ['测试', 'API'],
                        '收藏时间': Date.now()
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRecord)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ 测试记录创建成功', 'success');
                    log(`记录ID: ${data.data?.record?.record_id}`);
                } else {
                    log(`❌ 创建失败: ${data.msg}`, 'error');
                    log(`错误详情: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                log(`❌ 创建测试记录失败: ${error.message}`, 'error');
            }
        }

        async function searchRecords() {
            log('搜索记录...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const searchQuery = {
                    filter: {
                        conjunction: 'and',
                        conditions: [
                            {
                                field_name: '标签',
                                operator: 'contains',
                                value: ['测试']
                            }
                        ]
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchQuery)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ 搜索完成', 'success');
                    log(`找到 ${data.data?.items?.length || 0} 条记录`);
                } else {
                    log(`❌ 搜索失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 搜索记录失败: ${error.message}`, 'error');
            }
        }

        async function getAllRecords() {
            log('获取所有记录...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records?page_size=10`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('✅ 记录获取成功', 'success');
                    log(`共 ${data.data?.items?.length || 0} 条记录 (最多显示10条)`);
                } else {
                    log(`❌ 获取失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 获取记录失败: ${error.message}`, 'error');
            }
        }

        async function simulateBookmark() {
            log('模拟网页收藏操作...');
            
            const pageData = {
                title: '测试页面标题',
                url: window.location.href,
                description: '这是一个测试页面的描述',
                tags: ['测试', '网页收藏'],
                selectedText: '这是选中的文本内容',
                timestamp: new Date().toISOString()
            };
            
            await createTestRecord();
            log('✅ 网页收藏模拟完成', 'success');
        }

        async function testDuplicateCheck() {
            log('测试重复检查功能...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                const currentUrl = window.location.href;
                
                const searchQuery = {
                    filter: {
                        conjunction: 'and',
                        conditions: [
                            {
                                field_name: '链接',
                                operator: 'is',
                                value: [currentUrl]
                            }
                        ]
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchQuery)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    const existingCount = data.data?.items?.length || 0;
                    if (existingCount > 0) {
                        log(`⚠️  发现 ${existingCount} 条重复记录`, 'error');
                    } else {
                        log('✅ 没有发现重复记录', 'success');
                    }
                } else {
                    log(`❌ 重复检查失败: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`❌ 重复检查失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            log('🚀 飞书API测试页面已加载');
            log('请按顺序执行测试：1. 设置配置 → 2. 验证配置 → 3. 测试连接');
        });
    </script>
</body>
</html>