<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é£ä¹¦APIæµ‹è¯•é¡µé¢</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #6b7280; }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            min-height: 100px;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é£ä¹¦å¤šç»´è¡¨æ ¼APIæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. é…ç½®æµ‹è¯•</h3>
            <p class="info">é¦–å…ˆè®¾ç½®é£ä¹¦APIé…ç½®ä¿¡æ¯</p>
            <button onclick="setupConfig()">è®¾ç½®é…ç½®</button>
            <button onclick="verifyConfig()">éªŒè¯é…ç½®</button>
        </div>

        <div class="test-section">
            <h3>2. APIè¿æ¥æµ‹è¯•</h3>
            <p class="info">æµ‹è¯•ä¸é£ä¹¦APIçš„è¿æ¥</p>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button onclick="getTableInfo()">è·å–è¡¨æ ¼ä¿¡æ¯</button>
            <button onclick="getFields()">è·å–å­—æ®µä¿¡æ¯</button>
        </div>

        <div class="test-section">
            <h3>3. æ•°æ®æ“ä½œæµ‹è¯•</h3>
            <p class="info">æµ‹è¯•æ•°æ®çš„åˆ›å»ºã€è¯»å–å’Œæ›´æ–°</p>
            <button onclick="createTestRecord()">åˆ›å»ºæµ‹è¯•è®°å½•</button>
            <button onclick="searchRecords()">æœç´¢è®°å½•</button>
            <button onclick="getAllRecords()">è·å–æ‰€æœ‰è®°å½•</button>
        </div>

        <div class="test-section">
            <h3>4. æ¨¡æ‹Ÿæ’ä»¶æ“ä½œ</h3>
            <p class="info">æ¨¡æ‹Ÿæµè§ˆå™¨æ’ä»¶çš„å®é™…æ“ä½œ</p>
            <button onclick="simulateBookmark()">æ¨¡æ‹Ÿç½‘é¡µæ”¶è—</button>
            <button onclick="testDuplicateCheck()">æµ‹è¯•é‡å¤æ£€æŸ¥</button>
        </div>

        <div id="results">
            <p>æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
    </div>

    <script>
        const API_CONFIG = {
            tenantAccessToken: 't-g1049ffnJ7Z6E65FESDLBPIHQ6MAEQUOFFI6G5C4',
            baseId: 'H5xQwaTxDiDE6SkUulZcRgOoneh',
            tableId: 'tblQWm4ttkQD7QH0'
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').innerHTML = '';
        }

        async function setupConfig() {
            clearLog();
            log('è®¾ç½®é£ä¹¦APIé…ç½®...');
            
            try {
                // æ¨¡æ‹Ÿè®¾ç½®Chromeæ‰©å±•é…ç½®
                localStorage.setItem('feishu_config', JSON.stringify(API_CONFIG));
                log('âœ… é…ç½®è®¾ç½®æˆåŠŸ', 'success');
                log(`BaseID: ${API_CONFIG.baseId}`);
                log(`TableID: ${API_CONFIG.tableId}`);
            } catch (error) {
                log(`âŒ é…ç½®è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifyConfig() {
            log('éªŒè¯é…ç½®...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                const required = ['tenantAccessToken', 'baseId', 'tableId'];
                const missing = required.filter(key => !config[key]);
                
                if (missing.length > 0) {
                    log(`âŒ ç¼ºå°‘å¿…éœ€é…ç½®: ${missing.join(', ')}`, 'error');
                } else {
                    log('âœ… é…ç½®éªŒè¯é€šè¿‡', 'success');
                }
            } catch (error) {
                log(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            log('æµ‹è¯•APIè¿æ¥...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    log(`è¡¨æ ¼åç§°: ${data.data?.table?.name || 'æœªçŸ¥'}`);
                } else {
                    log(`âŒ APIè¿æ¥å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function getTableInfo() {
            log('è·å–è¡¨æ ¼ä¿¡æ¯...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… è¡¨æ ¼ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    log(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`);
                } else {
                    log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ è·å–è¡¨æ ¼ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function getFields() {
            log('è·å–å­—æ®µä¿¡æ¯...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/fields`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… å­—æ®µä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    log(`å…±æ‰¾åˆ° ${data.data?.items?.length || 0} ä¸ªå­—æ®µ:`);
                    
                    data.data?.items?.forEach((field, index) => {
                        log(`${index + 1}. ${field.field_name} (${field.type})`);
                    });
                } else {
                    log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ è·å–å­—æ®µä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createTestRecord() {
            log('åˆ›å»ºæµ‹è¯•è®°å½•...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const testRecord = {
                    fields: {
                        'æ ‡é¢˜': 'æµ‹è¯•ç½‘é¡µæ ‡é¢˜ - ' + new Date().toLocaleString(),
                        'é“¾æ¥': 'https://example.com/test-' + Date.now(),
                        'æè¿°': 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•è®°å½•',
                        'æ ‡ç­¾': ['æµ‹è¯•', 'API'],
                        'æ”¶è—æ—¶é—´': Date.now()
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRecord)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… æµ‹è¯•è®°å½•åˆ›å»ºæˆåŠŸ', 'success');
                    log(`è®°å½•ID: ${data.data?.record?.record_id}`);
                } else {
                    log(`âŒ åˆ›å»ºå¤±è´¥: ${data.msg}`, 'error');
                    log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºæµ‹è¯•è®°å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function searchRecords() {
            log('æœç´¢è®°å½•...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const searchQuery = {
                    filter: {
                        conjunction: 'and',
                        conditions: [
                            {
                                field_name: 'æ ‡ç­¾',
                                operator: 'contains',
                                value: ['æµ‹è¯•']
                            }
                        ]
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchQuery)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… æœç´¢å®Œæˆ', 'success');
                    log(`æ‰¾åˆ° ${data.data?.items?.length || 0} æ¡è®°å½•`);
                } else {
                    log(`âŒ æœç´¢å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ æœç´¢è®°å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function getAllRecords() {
            log('è·å–æ‰€æœ‰è®°å½•...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records?page_size=10`, {
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    log('âœ… è®°å½•è·å–æˆåŠŸ', 'success');
                    log(`å…± ${data.data?.items?.length || 0} æ¡è®°å½• (æœ€å¤šæ˜¾ç¤º10æ¡)`);
                } else {
                    log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ è·å–è®°å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function simulateBookmark() {
            log('æ¨¡æ‹Ÿç½‘é¡µæ”¶è—æ“ä½œ...');
            
            const pageData = {
                title: 'æµ‹è¯•é¡µé¢æ ‡é¢˜',
                url: window.location.href,
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡µé¢çš„æè¿°',
                tags: ['æµ‹è¯•', 'ç½‘é¡µæ”¶è—'],
                selectedText: 'è¿™æ˜¯é€‰ä¸­çš„æ–‡æœ¬å†…å®¹',
                timestamp: new Date().toISOString()
            };
            
            await createTestRecord();
            log('âœ… ç½‘é¡µæ”¶è—æ¨¡æ‹Ÿå®Œæˆ', 'success');
        }

        async function testDuplicateCheck() {
            log('æµ‹è¯•é‡å¤æ£€æŸ¥åŠŸèƒ½...');
            
            try {
                const config = JSON.parse(localStorage.getItem('feishu_config') || '{}');
                const currentUrl = window.location.href;
                
                const searchQuery = {
                    filter: {
                        conjunction: 'and',
                        conditions: [
                            {
                                field_name: 'é“¾æ¥',
                                operator: 'is',
                                value: [currentUrl]
                            }
                        ]
                    }
                };

                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${config.baseId}/tables/${config.tableId}/records/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.tenantAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchQuery)
                });

                const data = await response.json();
                
                if (data.code === 0) {
                    const existingCount = data.data?.items?.length || 0;
                    if (existingCount > 0) {
                        log(`âš ï¸  å‘ç° ${existingCount} æ¡é‡å¤è®°å½•`, 'error');
                    } else {
                        log('âœ… æ²¡æœ‰å‘ç°é‡å¤è®°å½•', 'success');
                    }
                } else {
                    log(`âŒ é‡å¤æ£€æŸ¥å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                log(`âŒ é‡å¤æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ é£ä¹¦APIæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('è¯·æŒ‰é¡ºåºæ‰§è¡Œæµ‹è¯•ï¼š1. è®¾ç½®é…ç½® â†’ 2. éªŒè¯é…ç½® â†’ 3. æµ‹è¯•è¿æ¥');
        });
    </script>
</body>
</html>